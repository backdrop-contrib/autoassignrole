<?php
define("AUTOASSIGNROLE_ROLE", "");
/**
 * Implementation of hook_menu().
 *
 * @return array
 */
function autoassignrole_menu($may_cache) {
  $items = array();
  if ($may_cache) {
    $items[] = array(
    'path' => 'admin/user/autoassignrole',
    'title' => t('Auto assign role'),
    'description' => t('Auto Assign Role Settings.'),
    'callback' => 'drupal_get_form',
    'callback arguments' => 'autoassignrole_settings',
    'access' => user_access('administer autoassignrole'),
    );
  }
  return $items;
}
function autoassignrole_settings() {
  $form['autoassignrole_settings'] = array(
  '#type' => 'fieldset',
  '#title' => t('Auto Assign Role Settings'),
  '#collapsible' => FALSE,
  '#collapsed' => FALSE,
  );
  $form['autoassignrole_settings']['AUTOASSIGNROLE_ROLE'] = array(
    '#type' => 'select',
    '#title' => t('Role'),
    '#default_value' => variable_get('AUTOASSIGNROLE_ROLE',''),
    '#options' => user_roles(),
    '#description' => t('Select the role to assign new users.'),
  );
  return system_settings_form($form);
}
/**
 * Implementation of hook_perm().
 * @return array
 */
function autoassignrole_perm() {
  return array('administer autoassignrole');
}

/**
 * Implementation of hook_user().
 */
function autoassignrole_user($type, &$edit, &$user, $category = NULL) {
  switch ($type) {
    case 'insert':
    case 'login':
      //Only assign the role if this is the first time the user has logged in.      
      if($user->login == 0 && variable_get('AUTOASSIGNROLE_ROLE','') != '') {
        db_query('INSERT INTO {users_roles} (uid, rid) values (%d, %d)', 
          $user->uid, 
          variable_get('AUTOASSIGNROLE_ROLE','') 
        );
      }
      break;
  }
}
